<!DOCTYPE html>
<html lang="en" class="h-100">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><%= title %> | OnTrack</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    
    <!-- Custom Results CSS -->
    <link rel="stylesheet" href="/styles/results.css" />

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body class="d-flex h-100 text-bg-dark">
    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
      <header class="mb-auto">
        <div>
          <a href="/" class="text-decoration-none">
            <h3 class="float-md-start mb-0">OnTrack</h3>
          </a>
          <nav class="nav nav-masthead justify-content-center float-md-end">
            <a class="nav-link fw-bold py-1 px-2" href="/">Home</a>
            <a class="nav-link fw-bold py-1 px-2" href="/features">Features</a>
            <a class="nav-link fw-bold py-1 px-2" href="/about">About</a>
            <a class="nav-link fw-bold py-1 px-2" href="/contact">Contact</a>
          </nav>
        </div>
      </header>

      <main class="px-3">
        <div class="hero-box-wide">
          <div class="page-header">
            <h2>Academic Progress Tracker</h2>
            <p class="program-name"><%= program %></p>
          </div>

          <% 
          // Helper function to calculate progress
          function calculateProgress(requirements) {
            if (Array.isArray(requirements)) {
              const met = requirements.filter(r => r.met).length;
              const total = requirements.length;
              return { met, total, percent: Math.round((met / total) * 100) };
            }
            return null;
          }
          %>

          <% Object.entries(progress).forEach(([section, requirements], idx) => { %>
            <% if (Array.isArray(requirements)) { %>
              <% const prog = calculateProgress(requirements); %>
              <div class="results-section">
                <button
                  class="section-header collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#section-<%= idx %>"
                  aria-expanded="false"
                  aria-controls="section-<%= idx %>">
                  <div class="section-title-wrapper">
                    <span>
                      <% if (section === "required_courses") { %>
                        Core Courses
                      <% } else if (section === "elective_requirement") { %>
                        Elective Requirements
                      <% } else if (section === "additional_requirement") { %>
                        Additional Requirements
                      <% } else { %>
                        <%= section %>
                      <% } %>
                    </span>
                    <% if (prog) { %>
                      <div class="section-progress">
                        <span><%= prog.met %>/<%= prog.total %></span>
                        <div class="progress-bar-container">
                          <div class="progress-bar-fill" style="width: <%= prog.percent %>%"></div>
                        </div>
                      </div>
                    <% } %>
                  </div>
                  <span class="collapse-icon">‚ñº</span>
                </button>

                <div class="collapse" id="section-<%= idx %>">
                  <% requirements.forEach(req => { %>
                    <div class="requirement-item">
                      <div class="requirement-header">
                        <span class="requirement-description"><%= req.description %></span>
                        <span class="badge <%= req.met ? 'met' : 'not-met' %>">
                          <%= req.met ? "‚úì Met" : "‚úó Not Met" %>
                        </span>
                      </div>
                      <div class="meta">
                        <div style="margin-bottom: 0.5rem;">
                          <span class="meta-label">Taken:</span>
                          <% if (req.courses_taken.length) { %>
                            <% req.courses_taken.forEach((c, i) => { %>
                              <a
                                href="https://uwflow.com/course/<%= c.code.toLowerCase() %>"
                                target="_blank"
                                rel="noopener"
                                class="course-code"
                                data-code="<%= c.code %>"
                                data-bs-toggle="tooltip"
                                data-bs-title="Loading UWFlow data...">
                                <%= c.code %>
                              </a>
                            <% }) %>
                          <% } else { %>
                            <span style="opacity: 0.6;">None</span>
                          <% } %>
                        </div>
                        <% if (req.type !== 'one_required' && req.type !== 'all_required') { %>
                          <div>
                            <span class="meta-label">Available Options:</span>
                            <% if (req.courses_remaining.length) { %>
                              <% req.courses_remaining.forEach((c, i) => { %>
                                <a
                                  href="https://uwflow.com/course/<%= c.code.toLowerCase() %>"
                                  target="_blank"
                                  rel="noopener"
                                  class="course-code"
                                  data-code="<%= c.code %>"
                                  data-bs-toggle="tooltip"
                                  data-bs-title="Loading UWFlow data...">
                                  <%= c.code %>
                                </a>
                              <% }) %>
                            <% } else { %>
                              <span style="opacity: 0.6;">None</span>
                            <% } %>
                          </div>
                        <% } %>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>

            <% } else if (section === "communication_requirement") { %>
              <% 
              const commTotal = Object.keys(requirements.lists).length;
              const commMet = Object.values(requirements.lists).filter(list => list.courses_taken.length > 0).length;
              const commPercent = Math.round((commMet / commTotal) * 100);
              %>
              <div class="results-section">
                <button
                  class="section-header collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#section-<%= idx %>"
                  aria-expanded="false"
                  aria-controls="section-<%= idx %>">
                  <div class="section-title-wrapper">
                    <span>Communication Requirements</span>
                    <div class="section-progress">
                      <span><%= commMet %>/<%= commTotal %></span>
                      <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: <%= commPercent %>%"></div>
                      </div>
                    </div>
                  </div>
                  <span class="collapse-icon">‚ñº</span>
                </button>

                <div class="collapse" id="section-<%= idx %>">
                  <% Object.entries(requirements.lists).forEach(([listName, list]) => { %>
                    <div class="requirement-item">
                      <div class="requirement-header">
                        <span class="requirement-description"><%= list.description %></span>
                      </div>
                      <div class="meta">
                        <div style="margin-bottom: 0.5rem;">
                          <span class="meta-label">Taken:</span>
                          <% if (list.courses_taken.length) { %>
                            <% list.courses_taken.forEach((c, i) => { %>
                              <a
                                href="https://uwflow.com/course/<%= c.code.toLowerCase() %>"
                                target="_blank"
                                rel="noopener"
                                class="course-code"
                                data-code="<%= c.code %>"
                                data-bs-toggle="tooltip"
                                data-bs-title="Loading UWFlow data...">
                                <%= c.code %>
                              </a>
                            <% }) %>
                          <% } else { %>
                            <span style="opacity: 0.6;">None</span>
                          <% } %>
                        </div>
                        <div>
                          <span class="meta-label">Available Options:</span>
                          <% if (list.courses_remaining.length) { %>
                            <% list.courses_remaining.forEach((c, i) => { %>
                              <a
                                href="https://uwflow.com/course/<%= c.code.toLowerCase() %>"
                                target="_blank"
                                rel="noopener"
                                class="course-code"
                                data-code="<%= c.code %>"
                                data-bs-toggle="tooltip"
                                data-bs-title="Loading UWFlow data...">
                                <%= c.code %>
                              </a>
                            <% }) %>
                          <% } else { %>
                            <span style="opacity: 0.6;">None</span>
                          <% } %>
                        </div>
                      </div>
                    </div>
                  <% }) %>

                  <h5 class="section-category-title">Communication Options</h5>
                  <% requirements.options.forEach(opt => { %>
                    <div class="requirement-item">
                      <div class="requirement-header">
                        <span class="requirement-description"><%= opt.description %></span>
                        <span class="badge <%= opt.met ? 'met' : 'not-met' %>">
                          <%= opt.met ? "‚úì Met" : "‚úó Not Met" %>
                        </span>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>

            <% } else if (section === "breadth_requirement") { %>
              <% 
              const breadthCategories = Object.values(requirements.categories);
              const breadthMet = breadthCategories.filter(c => c.met).length;
              const breadthTotal = breadthCategories.length;
              const breadthPercent = Math.round((breadthMet / breadthTotal) * 100);
              %>
              <div class="results-section">
                <button
                  class="section-header collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#section-<%= idx %>"
                  aria-expanded="false"
                  aria-controls="section-<%= idx %>">
                  <div class="section-title-wrapper">
                    <span>Breadth Requirement</span>
                    <div class="section-progress">
                      <span><%= breadthMet %>/<%= breadthTotal %></span>
                      <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: <%= breadthPercent %>%"></div>
                      </div>
                    </div>
                  </div>
                  <span class="collapse-icon">‚ñº</span>
                </button>

                <div class="collapse" id="section-<%= idx %>">
                  <div class="requirement-item">
                    <div class="requirement-header">
                      <span class="requirement-description">Overall Status</span>
                      <span class="badge <%= requirements.satisfied ? 'met' : 'not-met' %>">
                        <%= requirements.satisfied ? "‚úì Met" : "‚úó Not Met" %>
                      </span>
                    </div>
                    <div class="meta">
                      The Breadth Requirement ensures coverage across four areas:
                      Humanities, Social Sciences, Pure Sciences, and Applied Sciences.
                    </div>
                  </div>

                  <% Object.entries(requirements.categories).forEach(([cat, info]) => { %>
                    <div class="requirement-item">
                      <div class="requirement-header">
                        <span class="requirement-description">
                          <%= cat.charAt(0).toUpperCase() + cat.slice(1).replace(/_/g, " ") %>
                          (<%= info.units %> unit<%= info.units !== 1 ? 's' : '' %>)
                        </span>
                        <span class="badge <%= info.met ? 'met' : 'not-met' %>">
                          <%= info.met ? "‚úì Met" : "‚úó Not Met" %>
                        </span>
                      </div>
                      <div class="meta">
                        <div style="margin-bottom: 0.5rem;">
                          <span class="meta-label">Progress:</span>
                          <%= info.taken.length %>/<%= info.needed %>
                        </div>
                        <div>
                          <span class="meta-label">Courses Taken:</span>
                          <% if (info.taken.length) { %>
                            <% info.taken.forEach((c, i) => { %>
                              <a
                                href="https://uwflow.com/course/<%= c.trim().replace(/\s+/g, '').toLowerCase() %>"
                                target="_blank"
                                rel="noopener"
                                class="course-code"
                                data-code="<%= c.trim().replace(/\s+/g, '') %>"
                                data-bs-toggle="tooltip"
                                data-bs-title="Loading UWFlow data...">
                                <%= c %>
                              </a>
                            <% }) %>
                          <% } else { %>
                            <span style="opacity: 0.6;">None</span>
                          <% } %>
                        </div>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>

            <% } else if (section === "depth_requirement") { %>
              <div class="results-section">
                <button
                  class="section-header collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#section-<%= idx %>"
                  aria-expanded="false"
                  aria-controls="section-<%= idx %>">
                  <div class="section-title-wrapper">
                    <span>Depth Requirement</span>
                    <div class="section-progress">
                      <span class="badge <%= requirements.satisfied ? 'met' : 'not-met' %>" style="padding: 0.25rem 0.6rem;">
                        <%= requirements.satisfied ? "‚úì" : "‚úó" %>
                      </span>
                    </div>
                  </div>
                  <span class="collapse-icon">‚ñº</span>
                </button>

                <div class="collapse" id="section-<%= idx %>">
                  <div class="requirement-item">
                    <div class="meta" style="margin-bottom: 1rem;">
                      The Depth Requirement can be met in two ways:
                      <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                        <li>3 courses (1.5 units) from the same subject, with at least one at the third-year level or higher</li>
                        <li><strong>OR</strong> 3 courses (1.5 units) forming a prerequisite chain of length three</li>
                      </ul>
                    </div>
                    <div class="requirement-header">
                      <span class="requirement-description">Status</span>
                      <span class="badge <%= requirements.satisfied ? 'met' : 'not-met' %>">
                        <%= requirements.satisfied ? "‚úì Met" : "‚úó Not Met" %>
                      </span>
                    </div>
                    <% if (requirements.satisfied) { %>
                      <div class="meta" style="margin-top: 0.75rem;">
                        <div style="margin-bottom: 0.5rem;">
                          <span class="meta-label">Subject:</span> <%= requirements.subject %>
                        </div>
                        <div>
                          <span class="meta-label">Chain:</span> <%= (requirements.chain || []).slice().reverse().join(" ‚Üí ") %>
                        </div>
                      </div>
                    <% } else { %>
                      <div class="meta" style="margin-top: 0.75rem;">
                        <%= requirements.note %>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
            <% } %>
          <% }) %>
        </div>
      </main>

      <button class="btn-edit-courses py-3 " data-bs-toggle="modal" data-bs-target="#editCoursesModal">
        Edit Your Courses
      </button>

      <!-- Modal -->
      <div class="modal fade" id="editCoursesModal" tabindex="-1" aria-labelledby="editCoursesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <form action="/submit" method="POST">
              <div class="modal-header">
                <h5 class="modal-title" id="editCoursesModalLabel">Edit Your Courses</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" name="major" value="<%= program %>">
                <label for="courses" class="form-label">Courses (comma-separated):</label>
                <textarea name="courses" id="courses" class="form-control" rows="6"><%= userCourses %></textarea>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-secondary">Save Changes</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <footer class="mt-auto text-white-50 text-center">
        <br>&copy; 2025 OnTrack. All rights reserved.
      </br>
      Made with üíõ by the OnTrack team.
        </p>
      </footer>
    </div>

    <!-- UWFlow tooltips -->
    <script>
      const tooltipCache = new Map();
      let activeTooltip = null;

      document.querySelectorAll(".course-code").forEach(el => {
        const code = el.dataset.code;
        const tooltip = new bootstrap.Tooltip(el, { html: true, trigger: "hover" });

        el.addEventListener("mouseenter", async () => {
          if (activeTooltip && activeTooltip !== tooltip) {
            activeTooltip.hide();
          }
          activeTooltip = tooltip;

          tooltip.setContent({
            ".tooltip-inner": "Loading UWFlow data..."
          });
          tooltip.show();

          if (!tooltipCache.has(code)) {
            tooltipCache.set(
              code,
              fetch(`/api/uwflow/course/${code}`)
                .then(res => res.json())
                .catch(() => ({ error: true }))
            );
          }

          const data = await tooltipCache.get(code);

          if (activeTooltip !== tooltip) return;

          if (data.error) {
            tooltip.setContent({
              ".tooltip-inner": "No data available"
            });
            return;
          }

          tooltip.setContent({
            ".tooltip-inner": `
              <strong>${data.name}</strong><br>
              üëç Liked: ${Math.round(data.liked * 100)}%<br>
              üß† Useful: ${Math.round(data.useful * 100)}%<br>
              üòå Easy: ${Math.round(data.easy * 100)}%<br>
              üë• Ratings: ${data.filledCount}
            `
          });
        });

        el.addEventListener("mouseleave", () => {
          tooltip.hide();
          if (activeTooltip === tooltip) {
            activeTooltip = null;
          }
        });
      });
    </script>
  </body>
</html>